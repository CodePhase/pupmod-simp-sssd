<%
# Validation

Array(@ldap_uri).flatten.each do |t_uri|
  if not t_uri =~ /^ldap.?:\/\// then
    raise Puppet::ParseError.new(
      "Error: $ldap_uri must be an array of RFC 2732 compliant entries. Got: #{@ldap_uri}"
    )
  end
end

@ldap_chpass_uri.split(',').each do |t_uri|
  if not t_uri =~ /^ldap.?:\/\// then
    raise Puppet::ParseError.new(
      "Error: $ldap_chpass_uri must be an array of RFC 2732 compliant entries. Got: #{@ldap_chpass_uri}"
    )
  end
end

t_allowed_ldap_schemas = [
  'rfc2307',
  'rfc2307bis',
  'IPA'
 ]
if not t_allowed_ldap_schemas.include?(@ldap_schema) then
  raise Puppet::ParseError.new(
    "Error: ldap_schema must be one of '#{t_allowed_ldap_schemas.join("','")}'. Got: #{@ldap_schema}"
  )
end

if not @ldap_default_authtok_type.empty? then
  t_allowed_default_authtok_types = [
    'password',
    'obfuscated_password'
   ]
  if not t_allowed_default_authtok_types.include?(@ldap_default_authtok_type) then
    raise Puppet::ParseError.new(
      "Error: ldap_default_authtok_type must be one of '#{t_allowed_default_authtok_types.join("','")}'. Got: #{@ldap_default_authtok_type}"
    )
  end
end

t_should_be_integers = [
  'ldap_enumeration_refresh_timeout',
  'ldap_purge_cache_timeout',
  'ldap_group_nesting_level',
  'ldap_search_timeout',
  'ldap_enumeration_search_timeout',
  'ldap_network_timeout',
  'ldap_page_size',
  'ldap_krb5_ticket_lifetime'
]

t_should_be_integers.each do |t_int_var|
  t_evald_int_var = eval("@#{t_int_var}")
  if !t_evald_int_var.empty? and t_evald_int_var !~ /^\d+$/ then
    raise Puppet::ParseError.new(
      "Error: #{t_int_var} must be an integer. Got: #{t_evald_int_var}"
    )
  end
end

t_allowed_ldap_tls_reqcert_values = [
  'never',
  'allow',
  'try',
  'demand',
  'hard'
 ]

if !@ldap_tls_reqcert.empty? and !t_allowed_ldap_tls_reqcert_values.include?(@ldap_tls_reqcert) then
  raise Puppet::ParseError.new(
    "Error: ldap_tls_reqcert must be one of '#{t_allowed_ldap_tls_reqcert_values.join("','")}'. Got: #{@ldap_tls_reqcert}"
  )
end

t_allowed_ldap_pwd_policy_values = [
  'none',
  'shadow',
  'mit_kerberos'
 ]

if !@ldap_pwd_policy.empty? and !t_allowed_ldap_pwd_policy_values.include?(@ldap_pwd_policy) then
  raise Puppet::ParseError.new(
    "Error: ldap_pwd_policy must be one of '#{t_allowed_ldap_pwd_policy_values.join("','")}'. Got: #{ldap_pwd_policy}"
  )
end

t_allowed_ldap_account_expire_policy_values = [
  'none',
  'shadow',
  'ad',
  'rhds',
  'ipa',
  '389ds'
 ]

if !@ldap_account_expire_policy.empty? and !t_allowed_ldap_account_expire_policy_values.include?(@ldap_account_expire_policy) then
  raise Puppet::ParseError.new(
    "Error: ldap_account_expire_policy must be one of '#{t_allowed_ldap_account_expire_policy_values.join("','")}'. Got: #{ldap_account_expire_policy}"
  )
end

t_allowed_ldap_access_order_values = [
  'filter',
  'expire',
  'authorized_service'
 ]

if !@ldap_access_order.empty? then
  @ldap_access_order.split(',').each do |t_i|
    t_lao_count = 0
    @ldap_access_order.split.each { |t_j| t_j == t_i and t_lao_count += 1 }
    if t_lao_count > 1
      raise Puppet::ParseError.new(
        "Error: ldap_access_order must not have duplicate elements. Got: #{@ldap_access_order}}"
      )
    end
  end
  @ldap_access_order.split(',').each do |t_lao_val|
    if !t_allowed_ldap_access_order_values.include?(t_lao_val) then
      raise Puppet::ParseError.new(
       "Error: ldap_access_order must be one of '#{t_allowed_ldap_access_order_values.join("','")}'. Got: #{t_lao_val}"
      )
    end
  end
end

t_allowed_ldap_deref_values = [
  'never',
  'searching',
  'finding',
  'always'
 ]

if !@ldap_deref.empty? and !t_allowed_ldap_deref_values.include?(@ldap_deref) then
  raise Puppet::ParseError.new(
    "Error: ldap_deref must be one of '#{t_allowed_ldap_deref_values.join("','")}'. Got: #{@ldap_deref}"
  )
end
-%>

ldap_uri = <%= Array(@ldap_uri).join(',').gsub(/\s+/,',') %>
ldap_chpass_uri = <%= @ldap_chpass_uri %>
ldap_search_base = <%= @ldap_search_base %>
ldap_schema = <%= @ldap_schema %>
ldap_default_bind_dn = <%= @ldap_default_bind_dn %>
<% if not @ldap_default_authtok_type.empty? then -%>
ldap_default_authtok_type = <%= @ldap_default_authtok_type %>
<% end -%>
ldap_default_authtok = <%= @ldap_default_authtok %>
<% if not @ldap_user_object_class.empty? then -%>
ldap_user_object_class = <%= @ldap_user_object_class %>
<% end -%>
<% if not @ldap_user_name.empty? then -%>
ldap_user_name = <%= @ldap_user_name %>
<% end -%>
<% if not @ldap_user_uid_number.empty? then -%>
ldap_user_uid_number = <%= @ldap_user_uid_number %>
<% end -%>
<% if not @ldap_user_gid_number.empty? then -%>
ldap_user_gid_number = <%= @ldap_user_gid_number %>
<% end -%>
<% if not @ldap_user_gecos.empty? then -%>
ldap_user_gecos = <%= @ldap_user_gecos %>
<% end -%>
<% if not @ldap_user_home_directory.empty? then -%>
ldap_user_home_directory = <%= @ldap_user_home_directory %>
<% end -%>
<% if not @ldap_user_shell.empty? then -%>
ldap_user_shell = <%= @ldap_user_shell %>
<% end -%>
<% if not @ldap_user_uuid.empty? then -%>
ldap_user_uuid = <%= @ldap_user_uuid %>
<% end -%>
<% if not @ldap_user_modify_timestamp.empty? then -%>
ldap_user_modify_timestamp = <%= @ldap_user_modify_timestamp %>
<% end -%>
<% if not @ldap_user_shadow_last_change.empty? then -%>
ldap_user_shadow_last_change = <%= @ldap_user_shadow_last_change %>
<% end -%>
<% if not @ldap_user_shadow_min.empty? then -%>
ldap_user_shadow_min = <%= @ldap_user_shadow_min %>
<% end -%>
<% if not @ldap_user_shadow_max.empty? then -%>
ldap_user_shadow_max = <%= @ldap_user_shadow_max %>
<% end -%>
<% if not @ldap_user_shadow_warning.empty? then -%>
ldap_user_shadow_warning = <%= @ldap_user_shadow_warning %>
<% end -%>
<% if not @ldap_user_shadow_inactive.empty? then -%>
ldap_user_shadow_inactive = <%= @ldap_user_shadow_inactive %>
<% end -%>
<% if not @ldap_user_shadow_expire.empty? then -%>
ldap_user_shadow_expire = <%= @ldap_user_shadow_expire %>
<% end -%>
<% if not @ldap_user_krb_last_pwd_change.empty? then -%>
ldap_user_krb_last_pwd_change = <%= @ldap_user_krb_last_pwd_change %>
<% end -%>
<% if not @ldap_user_krb_password_expiration.empty? then -%>
ldap_user_krb_password_expiration = <%= @ldap_user_krb_password_expiration %>
<% end -%>
<% if not @ldap_user_ad_account_expires.empty? then -%>
ldap_user_ad_account_expires = <%= @ldap_user_ad_account_expires %>
<% end -%>
<% if not @ldap_user_ad_user_account_control.empty? then -%>
ldap_user_ad_user_account_control = <%= @ldap_user_ad_user_account_control %>
<% end -%>
<% if not @ldap_ns_account_lock.empty? then -%>
ldap_ns_account_lock = <%= @ldap_ns_account_lock %>
<% end -%>
<% if not @ldap_user_principal.empty? then -%>
ldap_user_principal = <%= @ldap_user_principal %>
<% end -%>
<% if not @ldap_force_upper_case_realm.empty? then -%>
ldap_force_upper_case_realm = <%= @ldap_force_upper_case_realm %>
<% end -%>
<% if not @ldap_enumeration_refresh_timeout.empty? then -%>
ldap_enumeration_refresh_timeout = <%= @ldap_enumeration_refresh_timeout %>
<% end -%>
<% if not @ldap_purge_cache_timeout.empty? then -%>
ldap_purge_cache_timeout = <%= @ldap_purge_cache_timeout %>
<% end -%>
<% if not @ldap_user_fullname.empty? then -%>
ldap_user_fullname = <%= @ldap_user_fullname %>
<% end -%>
<% if not @ldap_user_member_of.empty? then -%>
ldap_user_member_of = <%= @ldap_user_member_of %>
<% end -%>
<% if not @ldap_user_authorized_service.empty? then -%>
ldap_user_authorized_service = <%= @ldap_user_authorized_service %>
<% end -%>
<% if not @ldap_group_object_class.empty? then -%>
ldap_group_object_class = <%= @ldap_group_object_class %>
<% end -%>
<% if not @ldap_group_name.empty? then -%>
ldap_group_name = <%= @ldap_group_name %>
<% end -%>
<% if not @ldap_group_gid_number.empty? then -%>
ldap_group_gid_number = <%= @ldap_group_gid_number %>
<% end -%>
<% if not @ldap_group_member.empty? then -%>
ldap_group_member = <%= @ldap_group_member %>
<% end -%>
<% if not @ldap_group_uuid.empty? then -%>
ldap_group_uuid = <%= @ldap_group_uuid %>
<% end -%>
<% if not @ldap_group_modify_timestamp.empty? then -%>
ldap_group_modify_timestamp = <%= @ldap_group_modify_timestamp %>
<% end -%>
<% if not @ldap_group_nesting_level.empty? then -%>
ldap_group_nesting_level = <%= @ldap_group_nesting_level %>
<% end -%>
<% if not @ldap_netgroup_object_class.empty? then -%>
ldap_netgroup_object_class = <%= @ldap_netgroup_object_class %>
<% end -%>
<% if not @ldap_netgroup_name.empty? then -%>
ldap_netgroup_name = <%= @ldap_netgroup_name %>
<% end -%>
<% if not @ldap_netgroup_member.empty? then -%>
ldap_netgroup_member = <%= @ldap_netgroup_member %>
<% end -%>
<% if not @ldap_netgroup_triple.empty? then -%>
ldap_netgroup_triple = <%= @ldap_netgroup_triple %>
<% end -%>
<% if not @ldap_netgroup_uuid.empty? then -%>
ldap_netgroup_uuid = <%= @ldap_netgroup_uuid %>
<% end -%>
<% if not @ldap_netgroup_modify_timestamp.empty? then -%>
ldap_netgroup_modify_timestamp = <%= @ldap_netgroup_modify_timestamp %>
<% end -%>
ldap_search_timeout = <%= @ldap_search_timeout %>
ldap_enumeration_search_timeout = <%= @ldap_enumeration_search_timeout %>
ldap_network_timeout = <%= @ldap_network_timeout %>
ldap_opt_timeout = <%= @ldap_opt_timeout %>
ldap_page_size = <%= @ldap_page_size %>
ldap_tls_reqcert = <%= @ldap_tls_reqcert %>
<%  if not @ldap_tls_cacert.empty? then -%>
ldap_tls_cacert = <%= @ldap_tls_cacert %>
<%  end -%>
ldap_tls_cacertdir = <%= @ldap_tls_cacertdir %>
ldap_tls_cert = <%= @ldap_tls_cert %>
ldap_tls_key = <%= @ldap_tls_key %>
ldap_tls_cipher_suite = <%= @ldap_tls_cipher_suite.join(':') %>
ldap_id_use_start_tls = <%= @ldap_id_use_start_tls %>
<% if not @ldap_sasl_mech.empty? then -%>
ldap_sasl_mech = <%= @ldap_sasl_mech %>
<% end -%>
<% if not @ldap_sasl_authid.empty? then -%>
ldap_sasl_authid = <%= @ldap_sasl_authid %>
<% end -%>
<% if not @ldap_krb5_keytab.empty? then -%>
ldap_krb5_keytab = <%= @ldap_krb5_keytab %>
<% end -%>
<% if not @ldap_krb5_init_creds.empty? then -%>
ldap_krb5_init_creds = <%= @ldap_krb5_init_creds %>
<% end -%>
<% if not @ldap_krb5_ticket_lifetime.empty? then -%>
ldap_krb5_ticket_lifetime = <%= @ldap_krb5_ticket_lifetime %>
<% end -%>
<% if not @krb5_server.empty? then -%>
krb5_server = <%= @krb5_server %>
<% end -%>
<% if not @krb5_realm.empty? then -%>
krb5_realm = <%= @krb5_realm %>
<% end -%>
<% if not @ldap_pwd_policy.empty? then -%>
ldap_pwd_policy = <%= @ldap_pwd_policy %>
<% end -%>
<% if not @ldap_referrals.empty? then -%>
ldap_referrals = <%= @ldap_referrals %>
<% end -%>
<% if not @ldap_dns_service_name.empty? then -%>
ldap_dns_service_name = <%= @ldap_dns_service_name %>
<% end -%>
<% if not @ldap_chpass_dns_service_name.empty? then -%>
ldap_chpass_dns_service_name = <%= @ldap_chpass_dns_service_name %>
<% end -%>
<% if not @ldap_access_filter.empty? then -%>
ldap_access_filter = <%= @ldap_access_filter %>
<% end -%>
ldap_account_expire_policy = <%= @ldap_account_expire_policy %>
<% if not @ldap_access_order.empty? then -%>
ldap_access_order = <%= @ldap_access_order %>
<% end -%>
<% if not @ldap_deref.empty? then -%>
ldap_deref = <%= @ldap_deref %>
<% end -%>
<% if not @ldap_netgroup_search_base.empty? then -%>
ldap_netgroup_search_base = <%= @ldap_netgroup_search_base %>
<% end -%>
<% if not @ldap_user_search_base.empty? then -%>
ldap_user_search_base = <%= @ldap_user_search_base %>
<% end -%>
<% if not @ldap_group_search_base.empty? then -%>
ldap_group_search_base = <%= @ldap_group_search_base %>
<% end -%>
